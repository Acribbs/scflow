---
title: "Clustering"
output: html_document
---

```{r setup, include=FALSE}
library(scater)
library(SummarizedExperiment)
library(SC3)
library(dplyr)
sce <- readRDS("sce.rds")
sce.pass <- readRDS("pass.rds")
```

# PCA {.tabset}

## Before filtering 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sce<- normalize(sce)
sce <- runPCA(sce)
reducedDimNames(sce)

#svg("Before_filtering_PCA.svg")
plotReducedDim(sce, use_dimred = "PCA")
#dev.off()
```


## After filtering 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sce.pass<- normalize(sce.pass)
sce.pass <- runPCA(sce.pass)

#svg("Pass_PCA.svg")
plotReducedDim(sce.pass, use_dimred = "PCA")
#dev.off()
```

# TSNE {.tabset}

t-distributed stochastic neighbour embedding (t-SNE) is widely used for visualizing complex single-cell data sets. The same procedure described for PCA plots can be applied to generate t-SNE plots using plotTSNE, with coordinates obtained using runTSNE via the Rtsne package. We strongly recommend generating plots with different random seeds and perplexity values, to ensure that any conclusions are robust to different visualizations.

## Before filtering 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
set.seed=100
sce <- runTSNE(sce, ncomponents = 2, ntop = 500,
                  exprs_values = "logcounts",
    use_dimred="PCA", check_duplicates = FALSE)
#svg("Before_clustering_tSNE.svg")
plotTSNE(sce, colour_by = sce@rowRanges@partitioning@NAMES[1])
#dev.off()
```

## After filtering

```{r, echo=FALSE, message=FALSE, warning=FALSE}
set.seed=100
sce.pass <- runTSNE(sce.pass, ncomponents = 2, ntop = 500,
                  exprs_values = "logcounts",
    use_dimred="PCA")
#svg("Pass_tSNE.svg")
plotTSNE(sce.pass, sce@rowRanges@partitioning@NAMES[1])
#dev.off()
```

# SC3 clustering

This clustering follows the SC3 package and will hopefully reveal clusters within the data. This particular analysis will take time to properly analyse.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sce.filtered <- sc3_estimate_k(sce.pass)
metadata(sce.filtered)$sc3$k_estimation
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
rowData(sce.filtered)$feature_symbol <- rownames(rowData(sce.filtered))

# Turn on gene_filter=TRUE if your data requires it
sce.filtered <- sc3(sce.filtered, ks = 5, biology = TRUE, gene_filter = FALSE, pct_dropout_max = 90, pct_dropout_min = 5)
```

## Visulaisation of the consensus matrix

```{r, echo=FALSE}
#svg("SC3_consensus.svg")
sc3_plot_consensus(sce.filtered, k = 5)
#dev.off()
```

## Visualisation of the expression matrix

```{r, echo=FALSE}
#svg("SC3_diff_exprs.svg")
sc3_plot_expression(sce.filtered, k = 5)
#dev.off()
```

## Identify marker genes that discriminate clusters

```{r, echo=FALSE}
#svg("Marker_genes.svg")
sc3_plot_markers(sce.filtered, k = 5)
#dev.off()
```

# Differential gene plots

```{r}
#svg("DE_genes.svg")
sc3_plot_de_genes(sce.filtered, k = 5, p.val=0.05)
#dev.off()

row_data <- rowData(sce.filtered)
de_genes <- row_data[ , grep("sc3_", colnames(row_data))]


de_genes <- as.data.frame(de_genes) %>% 
  rownames_to_column("SYMBOL")

dir.create("cluster_output.dir")
write.csv(de_genes, file = "cluster_output.dir/Sc3_de_genes.csv")
```

# Save RDS

```{r}
saveRDS(sce.filtered, file="pass_clustering.rds")
```
